# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools


default_platform(:android)

platform :android do
  desc "Build Android Binary"
  lane :build do
    Dir.chdir("..") do
      #       sh "./buildscript-android-release.sh"

      # Clean up previous builds
      FileUtils.rm_rf('build-android-release')
      FileUtils.mkdir_p('build-android-release')

      # Configure CMake build
      qt6_android_dir = ENV['Qt6_DIR_ANDROID']
      cmake_config_cmd = [
        "#{qt6_android_dir}_x86/bin/qt-cmake",
        '-G Ninja',
        '-DCMAKE_BUILD_TYPE:STRING=Release',
        '-DQT_ANDROID_BUILD_ALL_ABIS=ON',
        '-S .',
        '-B build-android-release'
      ].join(' ')

      UI.message('Configuring CMake build...')
      sh(cmake_config_cmd)

      # Build AAB
      UI.message('Building Android App Bundle...')
      sh('cmake --build build-android-release --target aab')

      # Move AAB to a consistent location
      aab_source = 'build-android-release/src/android-build/build/outputs/bundle/release/android-build-release.aab'
      aab_dest = 'build-android-release/addhoursandminutes.aab'
      FileUtils.mv(aab_source, aab_dest)

      # Sign the AAB
      UI.message('Signing Android App Bundle...')
      keystore_file = ENV['ANDROID_KEYSTORE_FILE']
      keystore_pass = ENV['ANDROID_KEYSTORE_PASS']

      sh(
        'jarsigner',
        '-keystore', keystore_file,
        '-storepass', keystore_pass,
        aab_dest,
        'Stefan Kebekus'
      )

      # Verify and provide output path
      UI.success("Signed AAB file is available at #{File.expand_path(aab_dest)}")
    end
  end

  desc "Updata Meta Data for Google Play"
  lane :metadata do
    # Update Changelog files
    matches = File.read("../CHANGELOG.md").scan(/^## \s*\[?(.*?)\]?\s*-\s*.*?\n(.*?)(?=^## |\z)/m)
    latest_version, changelog_text = matches.last
    major, minor, patch = latest_version.split('.').map(&:to_i)
    version_code = 100000 * major + 1000 * minor + patch
    File.write("metadata/android/en-US/#{version_code}.txt", changelog_text.strip)      
  end

  desc "Deploy a new version to Google Play - Beta"
  lane :deployBeta do
    build
    metadata
    #upload_to_play_store
  end
end
